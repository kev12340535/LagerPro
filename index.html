<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Lager Pro</title>

  <!-- PWA / iOS -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#05060a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Lager Pro" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root {
      --bg: #05060a;
      --bg-card: #0d0f18;
      --border: #1f2433;
      --accent: #3ea6ff;
      --danger: #ff4b5c;
      --text: #f5f7ff;
      --text-soft: #c0c4dd;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: #05060a;
      color: var(--text);
      padding: 10px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 900px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
    }

    .card {
      background: var(--bg-card);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
    }

    h2 {
      margin: 0 0 5px;
      font-size: 17px;
    }

    label {
      display: block;
      margin-top: 7px;
      font-size: 13px;
      color: var(--text-soft);
    }

    input, select, textarea {
      width: 100%;
      margin-top: 3px;
      padding: 8px;
      background: #080a12;
      border: 1px solid #222a40;
      border-radius: 7px;
      color: var(--text);
      font-size: 14px;
    }

    .btn {
      padding: 8px 15px;
      border-radius: 7px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-main { background: var(--accent); color: #000; font-weight: bold; }
    .btn-ghost { background: #12141f; border: 1px solid #2a3147; color: var(--text-soft); }

    .small-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid #2a3147;
      background: #090b14;
      color: var(--text-soft);
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: pointer;
    }

    .small-btn.danger { border-color: #ff4b5c; color: #ffb8c1; }
    .small-btn.marked { border-color: gold; background: rgba(255,215,0,0.2); color: gold; }

    .item-row {
      background: #090c18;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 7px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 5px;
    }
    .item-row.marked { border-color: gold; background: rgba(255,215,0,0.08); }

    .item-title { font-size: 12px; font-weight: bold; }
    .item-line { font-size: 10px; color: var(--text-soft); }

    .item-actions { display: flex; flex-direction: column; gap: 4px; }

    .sum-box {
      background: #101321;
      border: 1px solid #262c44;
      padding: 6px;
      border-radius: 8px;
      flex: 1;
      min-width: 100px;
    }

    .sum-label { font-size: 12px; color: var(--text-soft); }
    .sum-value { font-size: 14px; font-weight: bold; }

    .item-list { display: flex; flex-direction: column; gap: 6px; max-height: 60vh; overflow-y: auto; }
    .empty { font-size: 12px; color: var(--text-soft); text-align:center; padding:10px; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
    }
    .modal {
      background:#0d0f18;
      padding:10px;
      border-radius:10px;
      border:1px solid #2a3147;
      max-width:90%;
      max-height:90%;
      overflow:auto;
    }
    .modal-header { display:flex; justify-content:space-between; align-items:center; }
    .modal-header h3 { margin:0; font-size:15px; }
    .modal-close {
      background:#12141f; border:1px solid #2a3147; padding:4px 8px; border-radius:7px; font-size:12px; cursor:pointer;
    }
    .modal img { max-width:100%; border-radius:8px; }
  </style>
</head>
<body>
<div class="app">

  <h1>Lager Pro</h1>

  <!-- FORMULAR -->
  <div class="card">
    <h2>Artikel anlegen / bearbeiten</h2>

    <form id="form">
      <input type="hidden" id="id" />

      <label>Artikelname *</label>
      <input id="name" required>

      <label>Artikelnummer</label>
      <input id="sku">

      <label>Zustand</label>
      <select id="condition">
        <option value="">Ausw√§hlen...</option>
        <option>Neu</option>
        <option>Gebraucht</option>
      </select>

      <label>Gr√∂√üe</label>
      <input id="size">

      <label>Wo gekauft</label>
      <input id="where">

      <label>Menge *</label>
      <input id="qty" type="number" value="1">

      <label>Einkaufspreis pro St√ºck (‚Ç¨)</label>
      <input id="priceUnit" type="number" step="0.01">

      <label>Einkaufspreis gesamt (‚Ç¨)</label>
      <input id="priceTotal" type="number" step="0.01">

      <label>Kaufdatum</label>
      <input id="date" type="date">

      <label>Notiz</label>
      <textarea id="notes"></textarea>

      <label>Foto</label>
      <input id="photo" type="file" accept="image/*">

      <div style="margin-top:10px; display:flex; gap:6px;">
        <button type="submit" class="btn btn-main">Speichern</button>
        <button type="button" id="resetForm" class="btn btn-ghost">Leeren</button>
      </div>
    </form>
  </div>

  <!-- √úBERSICHT -->
  <div class="card">
    <h2>Lager√ºbersicht</h2>

    <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
      <div class="sum-box">
        <div class="sum-label">Artikel</div>
        <div class="sum-value" id="sumItems">0</div>
      </div>
      <div class="sum-box">
        <div class="sum-label">Menge</div>
        <div class="sum-value" id="sumQty">0</div>
      </div>
      <div class="sum-box">
        <div class="sum-label">Gesamtwert</div>
        <div class="sum-value" id="sumValue">0,00 ‚Ç¨</div>
      </div>
    </div>

    <input id="search" placeholder="Suche...">

    <div class="item-list" id="list">
      <div class="empty">Noch keine Artikel.</div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title"></h3>
        <button class="modal-close" id="modal-close">Schlie√üen</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

</div>

<script>
const STORAGE = "lagerPro_full_v1";
let items = [];
items = load();
render();

function load(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE)) || [];
  }catch(e){
    return [];
  }
}

function save(){
  localStorage.setItem(STORAGE, JSON.stringify(items));
}

function genId(){
  return "itm_" + Date.now().toString(36) + Math.random().toString(36).slice(2);
}

function openModal(title, html){
  document.getElementById("modal-title").textContent = title;
  document.getElementById("modal-content").innerHTML = html;
  document.getElementById("modal-backdrop").style.display = "flex";
}

function closeModal(){
  document.getElementById("modal-backdrop").style.display = "none";
}
document.getElementById("modal-close").onclick = closeModal;

// ----------------- RENDER --------------------
function render(){
  const list = document.getElementById("list");
  const search = document.getElementById("search").value.toLowerCase();
  list.innerHTML="";

  if (items.length === 0){
    list.innerHTML = '<div class="empty">Noch keine Artikel.</div>';
  }

  const sorted = items.slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));

  let sumItems = sorted.length;
  let sumQty = 0;
  let sumValue = 0;

  sorted
    .filter(it=>{
      const blob = (it.name+" "+it.sku+" "+it.condition+" "+it.where).toLowerCase();
      return blob.includes(search);
    })
    .forEach(item=>{
      sumQty += item.qty || 0;
      sumValue += item.totalPrice || 0;

      const row = document.createElement("div");
      row.className = "item-row" + (item.flagged ? " marked" : "");

      const main = document.createElement("div");
      main.style.flex = "1";

      main.innerHTML = `
        <div class="item-title">${item.name}</div>
        <div class="item-line">${item.sku ? "Art.-Nr.: "+item.sku : ""}</div>
        <div class="item-line">
          Menge: ${item.qty} 
          ${item.priceUnit ? " ¬∑ Stk: "+item.priceUnit.toFixed(2)+"‚Ç¨" : ""}
          ${item.totalPrice ? " ¬∑ Gesamt: "+item.totalPrice.toFixed(2)+"‚Ç¨" : ""}
        </div>
        <div class="item-line">${item.date ? "Gekauft am "+item.date : ""}</div>
      `;

      const actions = document.createElement("div");
      actions.className="item-actions";

      const btnFlag = document.createElement("button");
      btnFlag.className = "small-btn" + (item.flagged ? " marked" : "");
      btnFlag.innerHTML = "‚≠ê";
      btnFlag.onclick = ()=>{
        item.flagged = !item.flagged;
        save(); render();
      };

      const btnEdit = document.createElement("button");
      btnEdit.className="small-btn";
      btnEdit.innerHTML="‚úèÔ∏è";
      btnEdit.onclick=()=>{ fillForm(item.id); window.scrollTo({top:0, behavior:"smooth"}); };

      const btnNotes = document.createElement("button");
      btnNotes.className="small-btn";
      btnNotes.innerHTML="üìù";
      btnNotes.onclick=()=>{ 
        openModal("Notiz", item.notes ? item.notes.replace(/\n/g,"<br>") : "<i>Keine Notiz.</i>");
      };

      const btnPhoto = document.createElement("button");
      btnPhoto.className="small-btn";
      btnPhoto.innerHTML="üì∑";
      btnPhoto.onclick=()=>{
        if (!item.photo){
          openModal("Foto", "<i>Kein Foto vorhanden</i>");
        } else {
          openModal(item.name, `<img src="${item.photo}">`);
        }
      };

      const btnDelete = document.createElement("button");
      btnDelete.className="small-btn danger";
      btnDelete.innerHTML="üóëÔ∏è";
      btnDelete.onclick=()=>{
        if (confirm("Wirklich l√∂schen?")){
          items = items.filter(x=>x.id!==item.id);
          save(); render();
        }
      };

      actions.append(btnFlag, btnEdit, btnNotes, btnPhoto, btnDelete);
      row.append(main, actions);
      list.append(row);
    });

  document.getElementById("sumItems").textContent = sumItems;
  document.getElementById("sumQty").textContent = sumQty;
  document.getElementById("sumValue").textContent = sumValue.toFixed(2).replace(".",",")+" ‚Ç¨";
}

// ----------------- FORMULAR -------------------
function fillForm(id){
  const it = items.find(x=>x.id===id);
  if (!it) return;

  id.value = it.id;
  name.value = it.name;
  sku.value = it.sku;
  condition.value = it.condition;
  size.value = it.size;
  where.value = it.where;
  qty.value = it.qty;
  priceUnit.value = it.priceUnit;
  priceTotal.value = it.totalPrice;
  date.value = it.date;
  notes.value = it.notes;
}

document.getElementById("resetForm").onclick = ()=>{
  form.reset();
  id.value="";
};

// ----------------- SPEICHERN --------------------
form.addEventListener("submit", async (e)=>{
  e.preventDefault();

  let nameVal = name.value.trim();
  if (!nameVal){ alert("Name fehlt"); return; }

  let qtyVal = parseInt(qty.value)||1;
  let unit = priceUnit.value ? parseFloat(priceUnit.value) : null;
  let total = priceTotal.value ? parseFloat(priceTotal.value) : null;

  if (unit!=null && total==null) total = qtyVal*unit;
  if (unit==null && total!=null) unit = total/qtyVal;

  let photoData = null;
  if (photo.files && photo.files[0]){
    photoData = await new Promise(res=>{
      let r=new FileReader();
      r.onload=()=>res(r.result);
      r.readAsDataURL(photo.files[0]);
    });
  }

  let existingIndex = items.findIndex(x=>x.id===id.value);
  let newId = id.value || genId();

  const item = {
    id: newId,
    name: nameVal,
    sku: sku.value.trim(),
    condition: condition.value,
    size: size.value.trim(),
    where: where.value.trim(),
    qty: qtyVal,
    priceUnit: unit,
    totalPrice: total,
    date: date.value,
    notes: notes.value.trim(),
    flagged: existingIndex>=0 ? items[existingIndex].flagged : false,
    photo: photoData ? photoData : (existingIndex>=0 ? items[existingIndex].photo : null)
  };

  if (existingIndex>=0) items[existingIndex]=item;
  else items.push(item);

  save();
  form.reset();
  id.value="";
  render();
});

// Suche
document.getElementById("search").oninput = render;

// Service Worker
if ("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
