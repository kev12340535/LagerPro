<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Lager Pro</title>

<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#05060a" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon" href="icon-192.png" />

<style>
  body {
    margin: 0;
    background: #05060a;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 12px;
    display: flex;
    justify-content: center;
  }

  .app {
    width: 100%;
    max-width: 900px;
  }

  h1 {
    margin: 0 0 10px;
    font-size: 22px;
  }

  .card {
    background: #0d0f18;
    border: 1px solid #1f2433;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 14px;
  }

  h2 { margin: 0 0 8px; font-size: 17px; }

  label { color: #b8bfd9; font-size: 13px; margin-top: 7px; display: block; }

  input, select, textarea {
    width: 100%;
    margin-top: 3px;
    padding: 8px;
    background: #080a12;
    border: 1px solid #222a40;
    border-radius: 8px;
    color: white;
    font-size: 14px;
  }

  textarea { min-height: 60px; }

  .btn-main {
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    background: #3ea6ff;
    color: black;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-ghost {
    padding: 10px 14px;
    border-radius: 8px;
    background: #12141f;
    border: 1px solid #2a3147;
    color: #b8bfd9;
    cursor: pointer;
  }

  .small-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: 1px solid #2a3147;
    background: #12141f;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    cursor: pointer;
  }

  .small-btn.marked {
    border-color: gold;
    background: rgba(255,215,0,0.2);
    color: gold;
  }

  .small-btn.danger {
    border-color: #ff4b5c;
    color: #ff9aa5;
  }

  .item-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 6px;
    padding: 8px;
    background: #090c18;
    border: 1px solid #1f2433;
    border-radius: 8px;
  }

  .item-row.marked {
    border-color: gold;
    background: rgba(255,215,0,0.1);
  }

  .item-title { font-size: 12px; font-weight: bold; }
  .item-line { font-size: 10px; color: #b8bfd9; }

  .item-actions {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .sum-box {
    background: #101321;
    border: 1px solid #262c44;
    padding: 6px;
    border-radius: 8px;
    flex: 1;
    min-width: 100px;
  }

  .sum-label { font-size: 12px; color: #b8bfd9; }
  .sum-value { font-size: 14px; font-weight: bold; }

  .item-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 60vh;
    overflow-y: auto;
  }

  .empty { font-size: 12px; text-align: center; color: #b8bfd9; padding: 8px; }

  /* Modal */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }

  .modal {
    background:#0d0f18;
    padding:10px;
    border-radius:10px;
    border:1px solid #2a3147;
    max-width:90%;
    max-height:90%;
    overflow:auto;
  }

  .modal-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .modal-header h3 { margin:0; font-size:15px; }

  .modal-close {
    background:#12141f;
    color:#b8bfd9;
    border:1px solid #2a3147;
    padding:4px 8px;
    border-radius:7px;
    font-size:12px;
    cursor:pointer;
  }

  .modal img { max-width:100%; border-radius:8px; }

</style>
</head>
<body>
<div class="app">

<h1>Lager Pro</h1>

<!-- FORMULAR -->
<div class="card">
  <h2>Artikel anlegen / bearbeiten</h2>

  <form id="form">
    <input type="hidden" id="id" />

    <label>Artikelname *</label>
    <input id="name" required />

    <label>Artikelnummer</label>
    <input id="sku" />

    <label>Zustand</label>
    <select id="condition">
      <option value="">Ausw√§hlen‚Ä¶</option>
      <option>Neu</option>
      <option>Gebraucht</option>
    </select>

    <label>Gr√∂√üe</label>
    <input id="size" />

    <label>Wo gekauft</label>
    <input id="where" />

    <label>Menge *</label>
    <input id="qty" type="number" value="1" />

    <label>Einkaufspreis pro St√ºck (‚Ç¨)</label>
    <input id="priceUnit" type="number" step="0.01" />

    <label>Einkaufspreis gesamt (‚Ç¨)</label>
    <input id="priceTotal" type="number" step="0.01" />

    <label>Kaufdatum</label>
    <input id="date" type="date" />

    <label>Notiz</label>
    <textarea id="notes"></textarea>

    <label>Foto</label>
    <input id="photo" type="file" accept="image/*" />

    <div style="margin-top:10px; display:flex; gap:6px;">
      <button type="submit" class="btn-main">Speichern</button>
      <button type="button" id="resetForm" class="btn-ghost">Leeren</button>
    </div>
  </form>
</div>

<!-- √úBERSICHT -->
<div class="card">
  <h2>Lager√ºbersicht</h2>

  <div style="display:flex; gap:8px; margin-bottom:10px;">
    <div class="sum-box">
      <div class="sum-label">Artikel</div>
      <div class="sum-value" id="sumItems">0</div>
    </div>
    <div class="sum-box">
      <div class="sum-label">Menge</div>
      <div class="sum-value" id="sumQty">0</div>
    </div>
    <div class="sum-box">
      <div class="sum-label">Gesamtwert</div>
      <div class="sum-value" id="sumValue">0,00 ‚Ç¨</div>
    </div>
  </div>

  <input id="search" placeholder="Suche‚Ä¶" />

  <div class="item-list" id="list">
    <div class="empty">Noch keine Artikel.</div>
  </div>
</div>


<!-- MODAL -->
<div id="modal-backdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-title"></h3>
      <button class="modal-close" id="modal-close">Schlie√üen</button>
    </div>
    <div id="modal-content"></div>
  </div>
</div>


<script>
const STORAGE = "lagerPro_final_v2";
let items = load();
render();

function load(){
  try { return JSON.parse(localStorage.getItem(STORAGE)) || []; }
  catch { return []; }
}
function save(){ localStorage.setItem(STORAGE, JSON.stringify(items)); }
function genId(){ return "x" + Date.now().toString(36) + Math.random().toString(36).slice(2); }

function openModal(title, html){
  modal_title.innerText = title;
  modal_content.innerHTML = html;
  modal_backdrop.style.display = "flex";
}
modal_close.onclick = ()=> modal_backdrop.style.display = "none";


// FORMULAR SPEICHERN
form.addEventListener("submit", async (e)=>{
  e.preventDefault();

  let nameVal = name.value.trim();
  if (!nameVal){ alert("Bitte Name eingeben"); return; }

  let qtyVal = parseInt(qty.value)||1;
  let unit = priceUnit.value ? parseFloat(priceUnit.value) : null;
  let total = priceTotal.value ? parseFloat(priceTotal.value) : null;

  if (unit!=null && total==null) total = qtyVal * unit;
  if (unit==null && total!=null) unit = total / qtyVal;

  let photoData = null;
  if (photo.files && photo.files[0]){
    photoData = await new Promise(res=>{
      let r=new FileReader();
      r.onload=()=>res(r.result);
      r.readAsDataURL(photo.files[0]);
    });
  }

  let idVal = id.value || genId();
  let idx = items.findIndex(x=>x.id===idVal);

  const item = {
    id: idVal,
    name: nameVal,
    sku: sku.value.trim(),
    condition: condition.value,
    size: size.value.trim(),
    where: where.value.trim(),
    qty: qtyVal,
    priceUnit: unit ?? null,
    totalPrice: total ?? null,
    date: date.value,
    notes: notes.value.trim(),
    flagged: idx>=0 ? items[idx].flagged : false,
    photo: photoData ?? (idx>=0 ? items[idx].photo : null)
  };

  if (idx>=0) items[idx] = item;
  else items.push(item);

  save();
  form.reset();
  id.value="";
  render();
});

resetForm.onclick = ()=>{ form.reset(); id.value=""; };

search.oninput = render;


// ANZEIGE
function render(){
  list.innerHTML = "";
  const s = search.value.toLowerCase();

  if (!items.length){
    list.innerHTML='<div class="empty">Noch keine Artikel.</div>';
    updateSums();
    return;
  }

  const sorted = items.slice().sort((a,b)=>(b.date||"").localeCompare(a.date||""));

  sorted
    .filter(it=>{
      return (
        it.name.toLowerCase().includes(s) ||
        (it.sku||"").toLowerCase().includes(s) ||
        (it.where||"").toLowerCase().includes(s)
      );
    })
    .forEach(item=>{
      const row = document.createElement("div");
      row.className = "item-row" + (item.flagged ? " marked" : "");

      const main = document.createElement("div");
      main.style.flex="1";
      main.innerHTML = `
        <div class="item-title">${item.name}</div>
        <div class="item-line">${item.sku ? "Art.-Nr.: "+item.sku : ""}</div>
        <div class="item-line">Menge: ${item.qty}
          ${item.priceUnit ? " ¬∑ Stk: "+item.priceUnit.toFixed(2)+"‚Ç¨" : ""}
          ${item.totalPrice ? " ¬∑ Gesamt: "+item.totalPrice.toFixed(2)+"‚Ç¨" : ""}
        </div>
        <div class="item-line">${item.date ? "Gekauft am "+item.date : ""}</div>
      `;

      const actions = document.createElement("div");
      actions.className="item-actions";

      const btnFlag = document.createElement("button");
      btnFlag.className="small-btn"+(item.flagged?" marked":"");
      btnFlag.innerHTML="‚≠ê";
      btnFlag.onclick=()=>{
        item.flagged=!item.flagged;
        save(); render();
      };

      const btnEdit = document.createElement("button");
      btnEdit.className="small-btn";
      btnEdit.innerHTML="‚úèÔ∏è";
      btnEdit.onclick=()=>{ fillForm(item); window.scrollTo({top:0, behavior:"smooth"}); };

      const btnNote = document.createElement("button");
      btnNote.className="small-btn";
      btnNote.innerHTML="üìù";
      btnNote.onclick=()=> openModal("Notiz", item.notes ? item.notes.replace(/\n/g,"<br>") : "<i>Keine Notiz</i>");

      const btnPhoto = document.createElement("button");
      btnPhoto.className="small-btn";
      btnPhoto.innerHTML="üì∑";
      btnPhoto.onclick=()=>{
        if (!item.photo) openModal("Foto", "<i>Kein Foto vorhanden</i>");
        else openModal(item.name, `<img src="${item.photo}">`);
      };

      const btnDelete = document.createElement("button");
      btnDelete.className="small-btn danger";
      btnDelete.innerHTML="üóëÔ∏è";
      btnDelete.onclick=()=>{
        if (confirm("Wirklich l√∂schen?")){
          items = items.filter(x=>x.id!==item.id);
          save(); render();
        }
      };

      actions.append(btnFlag, btnEdit, btnNote, btnPhoto, btnDelete);
      row.append(main, actions);
      list.append(row);
    });

  updateSums();
}

function fillForm(item){
  id.value = item.id;
  name.value = item.name;
  sku.value = item.sku;
  condition.value = item.condition;
  size.value = item.size;
  where.value = item.where;
  qty.value = item.qty;
  priceUnit.value = item.priceUnit;
  priceTotal.value = item.totalPrice;
  date.value = item.date;
  notes.value = item.notes;
}

function updateSums(){
  let sumItems = items.length;
  let sumQty = items.reduce((a,b)=>a + (b.qty||0), 0);
  let sumValue = items.reduce((a,b)=>a + (b.totalPrice||0), 0);

  sumItemsEl.textContent = sumItems;
  sumQtyEl.textContent = sumQty;
  sumValueEl.textContent = sumValue.toFixed(2).replace(".",",")+" ‚Ç¨";
}

// SERVICE WORKER
if ("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
