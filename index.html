<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Lager Pro</title>

  <!-- PWA / iOS -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#05060a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Lager Pro" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root {
      --bg: #05060a;
      --bg-card: #0d0f18;
      --border: #1f2433;
      --accent: #3ea6ff;
      --accent-soft: rgba(62,166,255,0.2);
      --danger: #ff4b5c;
      --text: #f5f7ff;
      --text-soft: #c0c4dd;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #171c2b 0, #05060a 40%, #020309 100%);
      color: var(--text);
      padding: 10px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 900px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
    }

    .subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .badge {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(120,255,180,0.7);
      background: rgba(30,190,120,0.15);
      color: #d8ffe9;
      white-space: nowrap;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 12px;
    }

    h2 {
      margin: 0 0 4px;
      font-size: 17px;
    }

    label {
      display: block;
      margin-top: 7px;
      font-size: 13px;
      color: var(--text-soft);
    }

    input, select, textarea {
      width: 100%;
      margin-top: 3px;
      padding: 8px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #222a40;
      background: #080a12;
      color: var(--text);
    }

    textarea { resize: vertical; min-height: 70px; }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: rgba(62,166,255,0.75);
      box-shadow: 0 0 0 1px rgba(62,166,255,0.4);
    }

    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    @media (max-width: 600px) {
      .row-2 { grid-template-columns: 1fr; }
    }

    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-main {
      background: var(--accent);
      color: #000;
      font-weight: 600;
    }

    .btn-ghost {
      background: #12141f;
      color: var(--text-soft);
      border: 1px solid #2a3147;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #2a3147;
      background: #090b14;
      color: var(--text-soft);
      cursor: pointer;
    }

    .btn-small.danger {
      border-color: rgba(255,75,92,0.7);
      color: #ffd5dd;
    }

    .btn-small.marked {
      border-color: rgba(255,215,0,0.9);
      background: rgba(255,215,0,0.18);
      color: #fff4c4;
    }

    .btn + .btn {
      margin-left: 6px;
    }

    .form-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .sum-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .sum-box {
      flex: 1;
      min-width: 120px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #101321;
      border: 1px solid #262c44;
      font-size: 13px;
    }

    .sum-label {
      color: var(--text-soft);
    }

    .sum-value {
      font-weight: 600;
      margin-top: 2px;
    }

    #search {
      margin-bottom: 8px;
    }

    .item-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .item-row {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #1f2433;
      background: #090c18;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .item-row.marked {
      border-color: rgba(255,215,0,0.9);
      background: rgba(255,215,0,0.08);
    }

    .item-main {
      flex: 1;
      min-width: 0;
    }

    .item-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .item-line {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .item-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .empty {
      font-size: 12px;
      color: var(--text-soft);
      text-align: center;
      padding: 10px 4px;
    }

    /* simple Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      max-width: 90%;
      max-height: 90%;
      background: #0d0f18;
      border-radius: 10px;
      border: 1px solid #2a3147;
      padding: 10px;
      color: var(--text);
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 15px;
    }

    .modal-close {
      border: none;
      background: #12141f;
      color: var(--text-soft);
      border-radius: 999px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .modal img {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
    }

  </style>
</head>
<body>
<div class="app">

  <header>
    <div>
      <h1>Lager Pro</h1>
      <div class="subtitle">Einfache Lagerverwaltung â€“ alles untereinander</div>
    </div>
    <div class="badge">Offline Â· Nur dieses GerÃ¤t</div>
  </header>

  <!-- Formular -->
  <div class="card">
    <h2>Artikel anlegen / bearbeiten</h2>

    <form id="form">
      <input type="hidden" id="id" />

      <label for="name">Artikelname *</label>
      <input id="name" required placeholder="z.B. Jacke, Schuhe, Werkzeug â€¦" />

      <label for="sku">Artikelnummer</label>
      <input id="sku" placeholder="z.B. interne Nummer, EAN â€¦" />

      <div class="row-2">
        <div>
          <label for="condition">Zustand</label>
          <select id="condition">
            <option value="">AuswÃ¤hlenâ€¦</option>
            <option>Neu</option>
            <option>Gebraucht</option>
          </select>
        </div>
        <div>
          <label for="size">GrÃ¶ÃŸe</label>
          <input id="size" placeholder="z.B. M, 42, 1L â€¦" />
        </div>
      </div>

      <label for="where">Wo gekauft</label>
      <input id="where" placeholder="z.B. Vinted, eBay, Laden â€¦" />

      <div class="row-2">
        <div>
          <label for="qty">Menge *</label>
          <input id="qty" type="number" min="1" value="1" />
        </div>
        <div>
          <label for="priceUnit">Einkaufspreis pro StÃ¼ck (â‚¬)</label>
          <input id="priceUnit" type="number" step="0.01" min="0" />
        </div>
      </div>

      <label for="priceTotal">Einkaufspreis gesamt (â‚¬)</label>
      <input id="priceTotal" type="number" step="0.01" min="0" />

      <label for="date">Wann gekauft</label>
      <input id="date" type="date" />

      <label for="notes">Notiz</label>
      <textarea id="notes" placeholder="Zustand, Besonderheiten, Seriennummer â€¦"></textarea>

      <label for="photo">Foto (optional)</label>
      <input id="photo" type="file" accept="image/*" />

      <div class="form-actions">
        <button type="submit" class="btn btn-main">ðŸ’¾ Speichern</button>
        <button type="button" id="resetForm" class="btn btn-ghost">Neu / Formular leeren</button>
      </div>
    </form>
  </div>

  <!-- Ãœbersicht -->
  <div class="card">
    <h2>LagerÃ¼bersicht</h2>

    <div class="sum-row">
      <div class="sum-box">
        <div class="sum-label">Artikel (Positionen)</div>
        <div class="sum-value" id="sumItems">0</div>
      </div>
      <div class="sum-box">
        <div class="sum-label">Gesamtmenge</div>
        <div class="sum-value" id="sumQty">0</div>
      </div>
      <div class="sum-box">
        <div class="sum-label">Gesamter Einkaufswert</div>
        <div class="sum-value" id="sumValue">0,00 â‚¬</div>
      </div>
    </div>

    <input id="search" placeholder="Suche nach Name, Nummer, Zustand, Ort â€¦" />

    <div class="item-list" id="list">
      <div class="empty">Noch keine Artikel angelegt.</div>
    </div>
  </div>

  <!-- Modal fÃ¼r Notiz/Foto -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" id="modal">
      <div class="modal-header">
        <h3 id="modal-title"></h3>
        <button class="modal-close" id="modal-close">SchlieÃŸen</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

</div>

<script>
const STORAGE_KEY = "lagerPro_v1";
let items = [];

function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  } catch (e) {
    console.error(e);
    return [];
  }
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
}

function genId() {
  return "itm_" + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

// DOM
const form = document.getElementById("form");
const idInput = document.getElementById("id");
const nameInput = document.getElementById("name");
const skuInput = document.getElementById("sku");
const conditionInput = document.getElementById("condition");
const sizeInput = document.getElementById("size");
const whereInput = document.getElementById("where");
const qtyInput = document.getElementById("qty");
const priceUnitInput = document.getElementById("priceUnit");
const priceTotalInput = document.getElementById("priceTotal");
const dateInput = document.getElementById("date");
const notesInput = document.getElementById("notes");
const photoInput = document.getElementById("photo");

const sumItemsEl = document.getElementById("sumItems");
const sumQtyEl = document.getElementById("sumQty");
const sumValueEl = document.getElementById("sumValue");
const listEl = document.getElementById("list");
const searchInput = document.getElementById("search");

const modalBackdrop = document.getElementById("modal-backdrop");
const modalTitle = document.getElementById("modal-title");
const modalContent = document.getElementById("modal-content");
const modalClose = document.getElementById("modal-close");

// Modal-Funktionen
function openModal(title, html) {
  modalTitle.textContent = title;
  modalContent.innerHTML = html;
  modalBackdrop.style.display = "flex";
}

function closeModal() {
  modalBackdrop.style.display = "none";
  modalTitle.textContent = "";
  modalContent.innerHTML = "";
}

modalClose.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => {
  if (e.target === modalBackdrop) closeModal();
});

// Render
function render() {
  const search = searchInput.value.trim().toLowerCase();
  listEl.innerHTML = "";

  if (!items.length) {
    const div = document.createElement("div");
    div.className = "empty";
    div.textContent = "Noch keine Artikel angelegt.";
    listEl.appendChild(div);
  }

  // Sortierung nach Kaufdatum (neu zuerst)
  const sorted = items.slice().sort((a,b) => {
    const da = a.date || "";
    const db = b.date || "";
    return db.localeCompare(da); // YYYY-MM-DD â†’ lexikalisch = chronologisch
  });

  let sumItems = sorted.length;
  let sumQty = 0;
  let sumValue = 0;

  sorted
    .filter(it => {
      if (!search) return true;
      const blob = (it.name + " " + it.sku + " " + it.condition + " " + it.size + " " + it.where).toLowerCase();
      return blob.includes(search);
    })
    .forEach(item => {
      sumQty += item.qty || 0;
      sumValue += item.totalPrice || 0;

      const row = document.createElement("div");
      row.className = "item-row" + (item.flagged ? " marked" : "");

      const main = document.createElement("div");
      main.className = "item-main";

      const title = document.createElement("div");
      title.className = "item-title";
      title.textContent = item.name;

      const line1 = document.createElement("div");
      line1.className = "item-line";
      const bits1 = [];
      if (item.sku) bits1.push("Art.-Nr.: " + item.sku);
      if (item.condition) bits1.push(item.condition);
      if (item.size) bits1.push("GrÃ¶ÃŸe: " + item.size);
      if (item.where) bits1.push("gekauft: " + item.where);
      line1.textContent = bits1.join(" Â· ") || "Keine weiteren Angaben";

      const line2 = document.createElement("div");
      line2.className = "item-line";
      let preisTxt = "";
      if (item.priceUnit != null) {
        preisTxt += "StÃ¼ck: " + item.priceUnit.toFixed(2) + " â‚¬";
      }
      if (item.totalPrice != null) {
        if (preisTxt) preisTxt += " Â· ";
        preisTxt += "Gesamt: " + item.totalPrice.toFixed(2) + " â‚¬";
      }
      line2.textContent = "Menge: " + (item.qty || 0) + (preisTxt ? " Â· " + preisTxt : "");

      const line3 = document.createElement("div");
      line3.className = "item-line";
      line3.textContent = item.date ? ("Gekauft am " + item.date) : "";

      main.appendChild(title);
      main.appendChild(line1);
      main.appendChild(line2);
      if (line3.textContent) main.appendChild(line3);

      const actions = document.createElement("div");
      actions.className = "item-actions";

      // Button: Markieren
      const btnFlag = document.createElement("button");
      btnFlag.className = "btn-small" + (item.flagged ? " marked" : "");
      btnFlag.textContent = item.flagged ? "Markierung aus" : "Markieren";
      btnFlag.addEventListener("click", (e) => {
        e.stopPropagation();
        item.flagged = !item.flagged;
        save();
        render();
      });

      // Button: Bearbeiten
      const btnEdit = document.createElement("button");
      btnEdit.className = "btn-small";
      btnEdit.textContent = "Bearbeiten";
      btnEdit.addEventListener("click", (e) => {
        e.stopPropagation();
        fillForm(item.id);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      // Button: Notiz anzeigen
      const btnNotes = document.createElement("button");
      btnNotes.className = "btn-small";
      btnNotes.textContent = "Notiz";
      btnNotes.addEventListener("click", (e) => {
        e.stopPropagation();
        const text = item.notes ? item.notes.replace(/\n/g,"<br>") : "<i>Keine Notiz vorhanden.</i>";
        openModal("Notiz â€“ " + item.name, "<p style='font-size:13px;'>" + text + "</p>");
      });

      // Button: Foto anzeigen
      const btnPhoto = document.createElement("button");
      btnPhoto.className = "btn-small";
      btnPhoto.textContent = "Foto";
      btnPhoto.addEventListener("click", (e) => {
        e.stopPropagation();
        if (!item.photo) {
          openModal("Foto â€“ " + item.name, "<p style='font-size:13px;'>Kein Foto hinterlegt.</p>");
        } else {
          openModal("Foto â€“ " + item.name, "<img src='" + item.photo + "' alt='Foto' />");
        }
      });

      // Button: LÃ¶schen
      const btnDelete = document.createElement("button");
      btnDelete.className = "btn-small danger";
      btnDelete.textContent = "LÃ¶schen";
      btnDelete.addEventListener("click", (e) => {
        e.stopPropagation();
        if (confirm("Diesen Artikel wirklich lÃ¶schen?")) {
          items = items.filter(x => x.id !== item.id);
          save();
          render();
        }
      });

      actions.appendChild(btnFlag);
      actions.appendChild(btnEdit);
      actions.appendChild(btnNotes);
      actions.appendChild(btnPhoto);
      actions.appendChild(btnDelete);

      row.appendChild(main);
      row.appendChild(actions);
      listEl.appendChild(row);
    });

  sumItemsEl.textContent = sumItems;
  sumQtyEl.textContent = sumQty;
  sumValueEl.textContent = sumValue.toFixed(2).replace(".", ",") + " â‚¬";
}

// Formular fÃ¼llen
function fillForm(id) {
  const it = items.find(x => x.id === id);
  if (!it) return;

  idInput.value = it.id;
  nameInput.value = it.name || "";
  skuInput.value = it.sku || "";
  conditionInput.value = it.condition || "";
  sizeInput.value = it.size || "";
  whereInput.value = it.where || "";
  qtyInput.value = it.qty != null ? it.qty : 1;
  priceUnitInput.value = it.priceUnit != null ? it.priceUnit : "";
  priceTotalInput.value = it.totalPrice != null ? it.totalPrice : "";
  dateInput.value = it.date || "";
  notesInput.value = it.notes || "";
}

// Formular speichern
form.addEventListener("submit", (e) => {
  e.preventDefault();

  const name = nameInput.value.trim();
  if (!name) {
    alert("Bitte einen Artikelnamen eingeben.");
    return;
  }

  let qty = parseInt(qtyInput.value, 10);
  if (!qty || qty < 1) qty = 1;

  let priceUnit = priceUnitInput.value ? parseFloat(priceUnitInput.value) : null;
  let priceTotal = priceTotalInput.value ? parseFloat(priceTotalInput.value) : null;

  // Wenn nur eins der beiden Felder befÃ¼llt â†’ das andere berechnen
  if (priceUnit != null && (priceTotal == null || isNaN(priceTotal))) {
    priceTotal = qty * priceUnit;
  } else if ((priceUnit == null || isNaN(priceUnit)) && priceTotal != null) {
    priceUnit = priceTotal / qty;
  }

  const id = idInput.value || genId();
  const existingIndex = items.findIndex(x => x.id === id);

  const item = {
    id,
    name,
    sku: skuInput.value.trim(),
    condition: conditionInput.value,
    size: sizeInput.value.trim(),
    where: whereInput.value.trim(),
    qty,
    priceUnit: priceUnit != null && !isNaN(priceUnit) ? priceUnit : null,
    totalPrice: priceTotal != null && !isNaN(priceTotal) ? priceTotal : null,
    date: dateInput.value || "",
    notes: notesInput.value.trim(),
    flagged: existingIndex >= 0 ? items[existingIndex].flagged : false,
    createdAt: existingIndex >= 0 ? (items[existingIndex].createdAt || new Date().toISOString()) : new Date().toISOString()
  };

  if (existingIndex >= 0) {
    items[existingIndex] = item;
  } else {
    items.push(item);
  }

  save();
  form.reset();
  idInput.value = "";
  render();
});

// Formular leeren
document.getElementById("resetForm").addEventListener("click", () => {
  form.reset();
  idInput.value = "";
});

// Suche
searchInput.addEventListener("input", () => render());

// Initial laden
items = load();
render();

// Service Worker fÃ¼r PWA registrieren
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").catch(err => {
      console.log("SW Fehler:", err);
    });
  });
}
</script>
</body>
</html>
